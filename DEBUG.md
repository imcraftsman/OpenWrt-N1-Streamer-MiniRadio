# N1 Radio 项目调试与测试指令全集（2025-2026 更新整理版）

## 0. 快速故障排查对照表（最常用总结）

| 序号 | 故障现象                     | 推荐排查顺序（建议按此顺序执行）                                                                                   |
|------|------------------------------|---------------------------------------------------------------------------------------------------------------------|
| 1    | 网页按钮完全无响应           | 1. 浏览器按 F12 打开开发者工具 → 查看「网络」或「控制台」接口报错<br>2. 命令行模拟请求：<br>   `QUERY_STRING="action=xxx" python3 /www/cgi-bin/radio_ctl.py` |
| 2    | 有歌名但完全没声音           | 1. `mpc status` 查看是否有错误提示<br>2. `alsamixer` 检查是否静音（MM）或音量过小<br>3. `mpc disable [ID]` 再 `mpc enable [ID]` 重启音频输出 |
| 3    | 歌名显示为乱码 / HTML / 代码 | 1. 执行 `mpc -f "%title%" current` 查看 MPD 拿到的原始元数据<br>2. 根据内容考虑在脚本中增加 XML/HTML 标签清洗逻辑      |
| 4    | 菜单 / 电台列表不显示        | 1. 检查 JSON 格式：`cat radio_data.json | python3 -m json.tool`<br>2. 测试接口：`QUERY_STRING="action=get_list" python3 /www/cgi-bin/radio_ctl.py` |
| 5    | 脚本执行报错：not found      | 1. 修复 Windows 行尾符：`sed -i 's/\r//' 文件名`<br>2. 赋予执行权限：`chmod +x 文件名`                           |
| 6    | 电台切换卡死 / 不响应        | 1. 单条流测试：`mpc clear`<br>   `mpc add http://...流地址...`<br>   `mpc play`<br>2. 正常播放 → 说明是播放列表问题 |
| 7    | 网页显示 500 Internal Server Error | 直接在终端运行脚本查看真实错误：<br>`python3 /www/cgi-bin/radio_ctl.py` 或带参数运行查看详细报错                   |

**小提示**：绝大多数“看起来很玄学”的问题，按照上面 1→7 的顺序逐个排查，基本都能在 5 分钟内定位到根因。

按**实际使用场景**与**问题定位层级**重新分类整理

## 1. 声卡硬件与音频输出层（最底层）

| 目的                         | 主要指令                              | 常用补充操作                          | 典型问题场景                              |
|------------------------------|---------------------------------------|---------------------------------------|-------------------------------------------|
| 检查声卡是否被识别           | `alsamixer`                           | 左右键切换项目，上下键调音量          | 开机无声音、插入声卡后没反应              |
| 检查/解除静音、调节音量      | 在 alsamixer 界面按 M 切换 MM→00      | Master / PCM 通道调到合理值           | 有进程在跑但完全没声音                    |
| 重启 ALSA 输出通道           | `mpc disable [ID]`<br>`mpc enable [ID]` | 先 `mpc outputs` 查看编号            | mpc status 显示 ALSA 打开失败             |
| 查看当前详细播放状态         | `mpc status`<br>`mpc current`         | `-f "%title%" current` 查看原始标题   | 有歌名但没声音 / 歌名乱码                 |

## 2. 文件格式与脚本执行环境修复

| 目的                               | 指令组合                                          | 典型错误现象                                  | 备注                              |
|------------------------------------|---------------------------------------------------|-----------------------------------------------|-----------------------------------|
| 修复 Windows 上传文件行尾符问题    | `sed -i 's/\r//' 文件名`                          | `-ash: ./xxx.py: not found`（文件明明存在）   | 几乎所有从 Win 传文件都会中招    |
| 赋予脚本执行权限                   | `chmod +x 文件名`                                 | `Permission denied`                           | 常与上面一起使用                  |
| 快速备份重要文件                   | `cp radio_ctl.py radio_ctl.py.bak`                | —                                             | 大改动前必做                      |

## 3. 后端 Python CGI 脚本调试

| 目的                               | 推荐指令                                          | 预期输出                                      | 常见问题                              |
|------------------------------------|---------------------------------------------------|-----------------------------------------------|---------------------------------------|
| 模拟前端请求查看输出               | `QUERY_STRING="action=status" python3 /www/cgi-bin/radio_ctl.py` | 标准 JSON 响应                                | 500 错误、接口无响应                  |
| 其他常用 action 测试               | `action=get_list`<br>`action=switch&id=xx`        | 电台列表 / 切换结果                           | JSON 格式错、前端不显示               |
| 直接检查语法错误（不依赖 web）     | `/usr/bin/python3 /www/cgi-bin/radio_ctl.py`      | 报 SyntaxError 或 ImportError                 | 页面 500 最快定位法                   |

## 4. MPD 播放引擎直接控制（MPC 指令集）

| 目的                               | 核心指令组合                                                                 | 使用场景                                      |
|------------------------------------|------------------------------------------------------------------------------|-----------------------------------------------|
| 清空 → 添加 → 播放测试单条流       | `mpc clear && mpc add http://... && mpc play`                                | 排除播放列表干扰，测试流是否可用              |
| 强制单曲模式（防自动跳台）         | `mpc single on`                                                              | SSL 报错后不停跳台时                         |
| 查看播放列表数量/内容              | `mpc playlist \| wc -l`<br>`mpc playlist \| head -n 5`                      | 确认列表是否正确加载                          |
| 插入并立即播放到最后一条           | `mpc insert http://... && mpc play $(mpc playlist \| wc -l)`                | 临时测试某条流不影响现有列表                  |
| 停止、重置常用组合                 | `mpc stop && mpc clear`                                                      | 状态混乱时归零                                |

## 5. 网络与流媒体连通性测试

| 目的                               | 指令                              | 判断依据                                  | 典型现象                              |
|------------------------------------|-----------------------------------|-------------------------------------------|---------------------------------------|
| 检查流地址是否可达                 | `curl -I http://...`              | 200 OK / 403 / 404 / timeout              | 歌名不更新、无声音但进程存在          |
| 流是否真的能下载数据               | `curl http://...stream.mp3 -o test.mp3`（前几秒后 Ctrl+C） | 文件大小是否增长                          | 连接成功但实际无音频数据              |

## 6. JSON 数据与电台列表管理

| 目的                               | 指令                                          | 作用                                          |
|------------------------------------|-----------------------------------------------|-----------------------------------------------|
| 快速检查 JSON 语法                 | `cat radio_data.json \| python3 -m json.tool` | 格式化输出，有错会直接报错行                  |
| 菜单不显示 / 列表为空              | 1. 校验 json 格式<br>2. 测试 `action=get_list` 接口 | —                                             |

## 7. 服务状态与进程检查（常用巡检指令）

```bash
# 检查 mpd 是否在运行
ps | grep mpd

# 检查 mpd 默认端口是否监听
netstat -tuln | grep 6600

# 查看播放列表存储目录是否存在内容
ls /tmp/lib/mpd/playlists/    # 软链或实际路径视配置而定

# 暴力重置 mpd 状态（慎用）
killall -9 mpd 2>/dev/null
rm -rf /var/lib/mpd /tmp/lib/mpd /var/run/mpd
# 然后重新生成播放列表
python3 fetch_set_playlist.py

